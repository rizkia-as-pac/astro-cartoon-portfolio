---
import { getCollection, type CollectionEntry } from "astro:content";
import "../styles/home.css";
import "../styles/posts.css";
import "../styles/page-transitions.css";
import Navigation from "../components/Navigation.astro";
import Footer from "../components/Footer.astro";
import { siteConfig } from "../config/site";
import { postImages, defaultPostImage } from "../config/posts-images";

const base = import.meta.env.BASE_URL;
const withBase = (path: string) => `${base}${path.replace(/^\//, "")}`;

// URL detector
const isExternalUrl = (href: string) => /^https?:\/\//i.test(href);

// Convert M/D/YYYY to timestamp (for reliable sorting)
function toTimestampFromMDY(dateString: string): number {
  if (!dateString) return 0;
  // expects M/D/YYYY
  const parts = dateString.split("/");
  if (parts.length !== 3) return 0;
  const [m, d, y] = parts;
  const dt = new Date(Number(y), Number(m) - 1, Number(d));
  const t = dt.getTime();
  return Number.isNaN(t) ? 0 : t;
}

// Convert date format from "6/27/2025" to "June 27, 2025"
function formatDate(dateString: string): string {
  const [month, day, year] = dateString.split("/");
  const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

// Get all posts from content collection
const allPosts = (await getCollection("posts")) as CollectionEntry<"posts">[];

// Transform content collection posts
const posts = await Promise.all(
  allPosts.map(async (post: any) => {
    let slug = post.slug;
    if (!slug && post.id) slug = post.id.split("/").pop()?.replace(/\.md$/, "") || "";
    if (!slug) console.warn("Post missing slug:", post);

    const rawDate = post.data.date; // keep original
    const date = formatDate(rawDate);
    const sortTs = toTimestampFromMDY(rawDate);

    let excerpt = post.data.excerpt;
    if (!excerpt) excerpt = `Read more about ${post.data.title}...`;

    // image: frontmatter > mapping > default
    const image = post.data.image || postImages[slug] || defaultPostImage;

    return {
      id: slug,
      date,
      rawDate,
      sortTs,
      title: post.data.title,
      tags: post.data.tags || [],
      excerpt,
      readTime: post.data.readTime || "5 min read",
      slug,
      image,
      link: post.data.link || null,
    };
  })
);

// Sort newest first using sortTs (reliable)
posts.sort((a, b) => (b.sortTs ?? 0) - (a.sortTs ?? 0));

// Group posts by formatted date
const groupedPosts = posts.reduce((acc, post) => {
  if (!acc[post.date]) acc[post.date] = [];
  acc[post.date].push(post);
  return acc;
}, {} as Record<string, typeof posts>);

// Extract all unique tags from posts
const allTags = Array.from(new Set(posts.flatMap((post) => post.tags))).sort();
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <!-- BASE_URL aware favicon -->
    <link rel="icon" type="image/svg+xml" href={withBase("/favicon.svg")} />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <title>Blog Posts - Ardhisa</title>
    <script>
      if ("scrollRestoration" in history) history.scrollRestoration = "manual";
      window.scrollTo(0, 0);
    </script>
  </head>

  <body>
    <Navigation />

    <main class="posts-page">
      <div class="posts-container page-content">
        <div class="posts-header posts-header-animate">
          <h1 class="posts-title">{siteConfig.posts.title}</h1>
          <p class="posts-subtitle">{siteConfig.posts.subtitle}</p>
        </div>

        <div class="search-filter-section posts-content-animate">
          <div class="search-box">
            <input
              type="text"
              placeholder={siteConfig.posts.searchPlaceholder}
              class="search-input"
              id="search-input"
            />
            <svg
              class="search-icon"
              width="20"
              height="20"
              viewBox="0 0 20 20"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"></path>
              <path
                d="m19 19-4.35-4.35"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"></path>
            </svg>
          </div>
        </div>

        <div class="tags-filter posts-content-animate">
          <span class="tags-label">Filter by tags:</span>
          <div class="tags-list">
            {allTags.map((tag) => (
              <button class="tag-button" data-tag={tag.toLowerCase().replace(/\s+/g, "-")}>
                {tag}
              </button>
            ))}
          </div>
        </div>

        <div class="posts-list posts-content-animate">
          {Object.entries(groupedPosts).map(([date, datePosts]) => (
            <div class="date-group" data-date={date}>
              <h2 class="date-header">{date}</h2>

              <div class="date-card">
                {datePosts.map((post) => {
                  const isExternal = !!post.link && isExternalUrl(post.link);
                  const href = isExternal ? post.link : withBase(`/posts/${post.slug}`);

                  // image path handling:
                  // - if starts with http(s) => external, keep
                  // - if starts with / => prepend BASE_URL
                  // - else (relative) keep as-is
                  const imgSrc = isExternalUrl(post.image)
                    ? post.image
                    : post.image?.startsWith("/")
                      ? withBase(post.image)
                      : post.image;

                  return (
                    <article class="post-item" data-post-id={post.slug}>
                      <div class="post-summary">
                        <div class="title-icon-left" />
                        <h3 class="post-title">
                          <a
                            href={href}
                            class="post-title-link"
                            target={isExternal ? "_blank" : undefined}
                            rel={isExternal ? "noopener noreferrer" : undefined}
                          >
                            {post.title}
                          </a>
                          <div class="title-icon-right" />
                        </h3>

                        {post.tags.length > 0 && (
                          <div class="post-tags">
                            {post.tags.map((tag: string) => (
                              <span class="post-tag">{tag}</span>
                            ))}
                          </div>
                        )}

                        <button class="post-toggle" aria-label="Toggle post details">
                          <span class="post-arrow">↓</span>
                        </button>
                      </div>

                      <div class="post-details">
                        <div class="post-content-wrapper">
                          <div class="post-excerpt-wrapper">
                            <p class="post-excerpt">{post.excerpt}</p>

                            <div class="post-footer">
                              <a
                                href={href}
                                class="post-read-more"
                                target={isExternal ? "_blank" : undefined}
                                rel={isExternal ? "noopener noreferrer" : undefined}
                              >
                                Read more →
                              </a>

                              <span class="post-read-time">⏱️ {post.readTime}</span>
                            </div>
                          </div>

                          <div class="post-image-container">
                            <img src={imgSrc} alt={post.title} class="post-image" loading="lazy" />
                          </div>
                        </div>
                      </div>
                    </article>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      </div>
    </main>

    <Footer />
  </body>
</html>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    window.scrollTo(0, 0);
    setTimeout(() => window.scrollTo(0, 0), 0);
  });

  window.addEventListener("pageshow", (event) => {
    if (event.persisted) window.scrollTo(0, 0);
  });

  document.addEventListener("DOMContentLoaded", () => {
    const pageContent = document.querySelector(".page-content");
    if (pageContent) requestAnimationFrame(() => pageContent.classList.add("visible"));

    const header = document.querySelector(".posts-header-animate");
    if (header) requestAnimationFrame(() => header.classList.add("visible"));

    const contentElements = document.querySelectorAll(".posts-content-animate");
    contentElements.forEach((el) => requestAnimationFrame(() => el.classList.add("visible")));
  });

  // Expand/collapse behavior
  const postToggles = document.querySelectorAll(".post-toggle");
  const postSummaries = document.querySelectorAll(".post-summary");

  postToggles.forEach((toggle) => {
    toggle.addEventListener("click", (e) => {
      e.stopPropagation();
      const postItem = toggle.closest(".post-item");
      if (!postItem) return;

      postItem.classList.toggle("expanded");
      const arrow = toggle.querySelector(".post-arrow");
      if (arrow) arrow.textContent = postItem.classList.contains("expanded") ? "↑" : "↓";
    });
  });

  postSummaries.forEach((summary) => {
    summary.addEventListener("click", (e) => {
      if ((e.target as HTMLElement).closest(".post-title-link")) return;
      if ((e.target as HTMLElement).closest(".post-toggle")) return;

      const postItem = summary.closest(".post-item");
      if (!postItem) return;

      postItem.classList.toggle("expanded");
      const arrow = postItem.querySelector(".post-arrow");
      if (arrow) arrow.textContent = postItem.classList.contains("expanded") ? "↑" : "↓";
    });
  });

  // Search filter
  const searchInput = document.getElementById("search-input");
  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
      const postItems = document.querySelectorAll(".post-item");

      postItems.forEach((item) => {
        const title = item.querySelector(".post-title a")?.textContent?.toLowerCase() || "";
        const excerpt = item.querySelector(".post-excerpt")?.textContent?.toLowerCase() || "";

        (item as HTMLElement).style.display =
          title.includes(searchTerm) || excerpt.includes(searchTerm) ? "block" : "none";
      });

      const dateGroups = document.querySelectorAll(".date-group");
      dateGroups.forEach((dateGroup) => {
        const visibleItems = dateGroup.querySelectorAll(
          '.post-item[style*="block"], .post-item:not([style*="none"])'
        );
        (dateGroup as HTMLElement).style.display = visibleItems.length > 0 ? "block" : "none";
      });
    });
  }

  // Tag filtering (multi-select)
  const tagButtons = document.querySelectorAll(".tag-button");
  const dateGroups = document.querySelectorAll(".date-group");

  function applyFilters() {
    const activeTags = Array.from(tagButtons)
      .filter((btn) => btn.classList.contains("active"))
      .map((btn) => btn.getAttribute("data-tag"))
      .filter((t): t is string => t !== null);

    if (activeTags.length === 0) {
      dateGroups.forEach((dateGroup) => {
        const items = dateGroup.querySelectorAll(".post-item");
        items.forEach((it) => ((it as HTMLElement).style.display = "block"));
        (dateGroup as HTMLElement).style.display = "block";
      });
      return;
    }

    dateGroups.forEach((dateGroup) => {
      const items = dateGroup.querySelectorAll(".post-item");
      let hasVisible = false;

      items.forEach((item) => {
        const postTags = Array.from(item.querySelectorAll(".post-tag"))
          .map((t) => t.textContent?.toLowerCase().replace(/\s+/g, "-") || "")
          .filter(Boolean);

        const match = activeTags.some((a) => postTags.includes(a));

        (item as HTMLElement).style.display = match ? "block" : "none";
        if (match) hasVisible = true;
      });

      (dateGroup as HTMLElement).style.display = hasVisible ? "block" : "none";
    });
  }

  tagButtons.forEach((button) => {
    button.addEventListener("click", () => {
      button.classList.toggle("active");
      applyFilters();
    });
  });
</script>
