---
import { getCollection } from "astro:content";
import "../../styles/home.css";
import "../../styles/post-detail.css";
import "../../styles/project-detail.css";
import "../../styles/page-transitions.css";
import Navigation from "../../components/Navigation.astro";
import Jack from "../../components/Jack.astro";
import Footer from "../../components/Footer.astro";

const base = import.meta.env.BASE_URL;

export async function getStaticPaths() {
  const projects = (await getCollection("projects")) as any[];

  return projects
    .map((project) => {
      // resolve slug inline (NO helper)
      let slug = project.slug;

      if (!slug && project.id) {
        // Extract slug from id (e.g., "projects/my-project.md" -> "my-project")
        slug = project.id.split("/").pop()?.replace(/\.md$/, "") || "";
      }

      if (!slug) {
        console.warn("Project missing slug in getStaticPaths:", project);
        return null;
      }

      // NOTE:
      // We keep passing project via props (same pattern as your posts page).
      // If your Astro build strips body, this still falls back to excerpt below.
      return {
        params: { slug },
        props: { project },
      };
    })
    .filter(Boolean);
}

interface Props {
  project: any;
}

const { project } = Astro.props;

if (!project) {
  throw new Error("Project is undefined");
}

let Content: any = null;

// 1) prefer rendered.Content kalau ada
if (project.rendered && typeof project.rendered === "object" && project.rendered.Content) {
  Content = project.rendered.Content;
}
// 2) fallback ke body manual render
else if (typeof project.body === "string" && project.body.trim().length > 0) {
  const { unified } = await import("unified");
  const remarkParse = (await import("remark-parse")).default;
  const remarkRehype = (await import("remark-rehype")).default;
  const rehypeStringify = (await import("rehype-stringify")).default;

  const processor = unified().use(remarkParse).use(remarkRehype).use(rehypeStringify);
  const result = await processor.process(project.body);
  Content = String(result);
}
// 3) kalau body/render tidak ada: tampilkan excerpt biar ada “deskripsi”
else {
  const fallback = project.data?.excerpt || "";
  Content = fallback ? `<p>${fallback}</p>` : "";
}

// Repo link (optional) - open in new tab if external
const repoHref: string | null = project.data?.repo || null;
const isExternalRepo = !!repoHref && /^https?:\/\//i.test(repoHref);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href={`${base}favicon.svg`} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <title>{project.data.title} - Projects</title>
    <script>
      if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual";
      }
      window.scrollTo(0, 0);
    </script>
  </head>

  <body>
    <Navigation />
    <Jack />

    <main class="post-detail-page">
      <div class="post-detail-container page-content">
        <div class="project-header-card project-header-animate">
          <div class="top-part">
            <h1 class="project-detail-title">{project.data.title}</h1>

            {
              project.data.techStack &&
                project.data.techStack.length > 0 && (
                  <div class="project-detail-techs">
                    {project.data.techStack.map((t: any) => (
                      <div class="project-detail-tech">
                        {t.icon && <img src={`${base}${String(t.icon).replace(/^\//, "")}`} loading="lazy" />}
                        <p>{t.name}</p>
                      </div>
                    ))}
                  </div>
                )
            }
          </div>

          <div class="post-detail-meta">
            <a href={`${base}projects`} class="post-back-button"> ← Back to Projects </a>

            {repoHref && (
              <a
                href={repoHref}
                class="project-more-button"
                target={isExternalRepo ? "_blank" : undefined}
                rel={isExternalRepo ? "noopener noreferrer" : undefined}
              >
                <img
                  src={`${base}svg/github2.svg`}
                  alt="Github"
                  style="height: 24px;"
                  loading="lazy"
                />
                <span>See more on github</span>
              </a>
            )}

            <div class="project-detail-meta-info">
              {project.data.organization && (
                <span class="post-detail-author">{project.data.organization}</span>
              )}

              {project.data.start_date && (
                <span class="post-detail-date">
                  {project.data.start_date} - {project.data.completion_date ?? "PRESENT"}
                </span>
              )}

              {!project.data.start_date && (
                <span class="post-detail-date">{project.data.date}</span>
              )}
              
            </div>
          </div>
        </div>

        {
          project.data.gallery &&
            project.data.gallery.length > 0 && (
              <!-- <div class="project-gallery"> -->
              <!--   {project.data.gallery.map((src: string) => ( -->
              <!--     <img -->
              <!--       src={`${base}${String(src).replace(/^\//, "")}`} -->
              <!--       alt="Image from project" -->
              <!--       loading="lazy" -->
              <!--     /> -->
              <!--   ))} -->
              <!-- </div> -->
              <div
        class="project-gallery"
        style={
          project.data.gallery_column
            ? `columns: ${project.data.gallery_column};`
        : `columns: 3;`
        }
      >
        {project.data.gallery.map((src: string) => (
          <img
            src={`${base}${String(src).replace(/^\//, "")}`}
            alt="Image from project"
            loading="lazy"
          />
        ))}
      </div>
            )
        }

        <div class="post-content post-content-animate">
          {
            typeof Content === "function" ? (
              <Content />
            ) : (
              <div set:html={Content} />
            )
          }
        </div>
      </div>
    </main>

    <Footer />

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        window.scrollTo(0, 0);
        setTimeout(() => window.scrollTo(0, 0), 0);
      });

      window.addEventListener("pageshow", (event) => {
        if (event.persisted) window.scrollTo(0, 0);
      });

      document.addEventListener("DOMContentLoaded", () => {
        const pageContent = document.querySelector(".page-content");
        if (pageContent) requestAnimationFrame(() => pageContent.classList.add("visible"));

        const header = document.querySelector(".project-header-animate");
        if (header) requestAnimationFrame(() => header.classList.add("visible"));

        const content = document.querySelector(".post-content-animate");
        if (content) requestAnimationFrame(() => content.classList.add("visible"));

        const applyHeadingSpacing = () => {
          const postContent = document.querySelector(".post-content");
          if (!postContent) return;

          const rootStyles = getComputedStyle(document.documentElement);
          const getCSSVar = (name, fallback) =>
            rootStyles.getPropertyValue(name).trim() || fallback;

          const headingConfig = [
            {
              selector: "h2",
              marginTopVar: "--post-h2-margin-top",
              marginBottomVar: "--post-h2-margin-bottom",
              contentMarginTopVar: "--post-h2-content-margin-top",
              defaults: { marginTop: "3rem", marginBottom: "1.17rem", contentMarginTop: "1.17rem" },
              skipFirstMarginTop: true,
            },
            {
              selector: "h3",
              marginTopVar: "--post-h3-margin-top",
              marginBottomVar: "--post-h3-margin-bottom",
              contentMarginTopVar: "--post-h3-content-margin-top",
              defaults: { marginTop: "2.5rem", marginBottom: "1rem", contentMarginTop: "1rem" },
              skipFirstMarginTop: false,
            },
            {
              selector: "h4",
              marginTopVar: "--post-h4-margin-top",
              marginBottomVar: "--post-h4-margin-bottom",
              contentMarginTopVar: "--post-h4-content-margin-top",
              defaults: { marginTop: "2rem", marginBottom: "0.83rem", contentMarginTop: "0.83rem" },
              skipFirstMarginTop: false,
            },
          ];

          const contentTags = ["P", "UL", "OL", "PRE"];

          headingConfig.forEach((config) => {
            const headings = postContent.querySelectorAll(config.selector);
            const marginTop = getCSSVar(config.marginTopVar, config.defaults.marginTop);
            const marginBottom = getCSSVar(config.marginBottomVar, config.defaults.marginBottom);
            const contentMarginTop = getCSSVar(config.contentMarginTopVar, config.defaults.contentMarginTop);

            headings.forEach((heading) => {
              if (!(heading instanceof HTMLElement)) return;

              if (config.skipFirstMarginTop && heading.previousElementSibling === null) {
                heading.style.marginTop = "0";
              } else {
                heading.style.marginTop = marginTop;
              }
              heading.style.marginBottom = marginBottom;

              const nextElement = heading.nextElementSibling;
              if (nextElement instanceof HTMLElement && contentTags.includes(nextElement.tagName)) {
                nextElement.style.marginTop = contentMarginTop;
              }
            });
          });
        };

        const overrideCodeStyles = () => {
          const codeBlocks = document.querySelectorAll(".post-content pre, .post-content pre.astro-code");
          codeBlocks.forEach((pre) => {
            if (pre instanceof HTMLElement) {
              pre.style.removeProperty("background-color");
              pre.style.removeProperty("color");
              pre.style.backgroundColor = "#f5f5f5";
              pre.style.borderRadius = "8px";
              pre.style.color = "#333";

              const code = pre.querySelector("code");
              if (code instanceof HTMLElement) {
                code.style.removeProperty("background-color");
                code.style.removeProperty("color");
                code.style.backgroundColor = "transparent";
                code.style.color = "#333";

                const spans = code.querySelectorAll("span");
                spans.forEach((span) => {
                  if (span instanceof HTMLElement) {
                    span.style.removeProperty("color");
                    span.style.color = "#333";
                  }
                });
              }
            }
          });
        };

        applyHeadingSpacing();
        overrideCodeStyles();

        setTimeout(() => {
          applyHeadingSpacing();
          overrideCodeStyles();
        }, 100);

        setTimeout(() => {
          applyHeadingSpacing();
          overrideCodeStyles();
        }, 500);
      });
    </script>
  </body>
</html>

